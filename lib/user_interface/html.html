<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Plant Monitor Dashboard</title>
    <style>body { font-family: 'Inter', 'Segoe UI', 'Roboto', Arial, sans-serif; }</style>
</head>
<body class="bg-[#e6f0ea] min-h-screen text-gray-800">
<div class="flex min-h-screen">
    <!-- Sidebar Left -->
    <aside class="hidden md:flex flex-col w-64 bg-[#F1F1F1] px-6 py-8 justify-between">
        <div>
            <div class="flex items-center gap-3 mb-10">
                <i class="fa fa-leaf text-green-700 text-3xl"></i>
                <span class="text-2xl font-extrabold text-green-700 tracking-wide">tkplant<span class="text-green-700">.</span></span>
            </div>
            <nav class="flex flex-col gap-2">
                <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg bg-white text-green-700 font-semibold shadow-sm"><i class="fa fa-home"></i>Dashboard</a>
                <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white text-gray-600"><i class="fa fa-file-alt"></i>Report</a>
                <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white text-gray-600"><i class="fa fa-cloud-sun"></i>Forecast</a>
                <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white text-gray-600"><i class="fa fa-tint"></i>Control</a>
                <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white text-gray-600"><i class="fa fa-cog"></i>Settings</a>
                <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white text-gray-600"><i class="fa fa-question-circle"></i>Help</a>
            </nav>
        </div>
        <div class="hidden md:block mt-10">
            <i class="fa fa-seedling text-green-400 text-6xl opacity-60 mx-auto"></i>
        </div>
    </aside>
    <!-- Main Content -->
    <main class="flex-1 flex flex-col bg-[#F1F1F1]">
        <!-- Header -->
        <header class="flex flex-col md:flex-row items-center justify-between px-6 py-6 bg-[#F1F1F1]">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Welcome, <span class="text-green-700">User!</span></h2>
                <div class="flex items-center gap-2 text-gray-400 text-sm mt-1">
                    <span id="current-date"></span>
                    <span id="current-time"></span>
                    <span id="status-badge" class="ml-2 inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700"><i class="fa fa-circle mr-1 text-green-500"></i>Online</span>
                </div>
            </div>
            <div class="flex items-center gap-3 mt-4 md:mt-0">
                <button class="bg-white p-2 rounded-full shadow hover:bg-gray-100"><i class="fa fa-search text-gray-500"></i></button>
                <button class="bg-white p-2 rounded-full shadow hover:bg-gray-100"><i class="fa fa-bell text-gray-500"></i></button>
            </div>
        </header>
        <!-- Sensor Card Row (Full Width) -->
        <div class="px-6 pt-6">
            <div class="w-full bg-white rounded-2xl shadow p-6 flex flex-col gap-4 min-w-[320px]">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-2">
                    <!-- Air Humidity Card -->
                    <div class="bg-gray-50 rounded-xl p-4 flex flex-col gap-2 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fa fa-tint text-[#537D5D] text-4xl p-6"></i>
                                <div>
                                    <div class="text-2xl font-bold text-gray-800" id="humidity-value">--</div>
                                    <div class="text-sm text-gray-400">Air Humidity</div>
                                </div>
                            </div>
                            <i class="fa fa-arrow-up text-green-400"></i>
                        </div>
                        <div class="w-full h-3 bg-gray-200 rounded-full mt-2">
                            <div id="humidity-bar" class="h-3 rounded-full transition-all duration-500" style="width:0%; background: linear-gradient(90deg, #93c5fd 0%, #fde68a 50%, #fca5a5 100%);"></div>
                        </div>
                        <div class="text-sm font-bold mt-1" id="humidity-percent">--</div>
                    </div>
                    <!-- Soil Moisture Card -->
                    <div class="bg-gray-50 rounded-xl p-4 flex flex-col gap-2 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fa fa-water text-[#537D5D] text-4xl p-6"></i>
                                <div>
                                    <div class="text-2xl font-bold text-gray-800" id="soil-moisture-value">--</div>
                                    <div class="text-sm text-gray-400">Soil Moisture</div>
                                </div>
                            </div>
                            <i class="fa fa-arrow-up text-green-400"></i>
                        </div>
                        <div class="w-full h-3 bg-gray-200 rounded-full mt-2">
                            <div id="soil-moisture-bar" class="h-3 rounded-full transition-all duration-500" style="width:0%; background: linear-gradient(90deg, #93c5fd 0%, #fde68a 50%, #fca5a5 100%);"></div>
                        </div>
                        <div class="text-sm font-bold mt-1" id="soil-moisture-percent">--</div>
                    </div>
                    <!-- Temperature Card -->
                    <div class="bg-gray-50 rounded-xl p-4 flex flex-col gap-2 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fa fa-thermometer-half text-[#537D5D] text-4xl p-6"></i>
                                <div>
                                    <div class="text-2xl font-bold text-gray-800" id="temperature-value">--</div>
                                    <div class="text-sm text-gray-400">Temperature</div>
                                </div>
                            </div>
                            <i class="fa fa-arrow-up text-green-400"></i>
                        </div>
                        <div class="w-full h-3 bg-gray-200 rounded-full mt-2">
                            <div id="temperature-bar" class="h-3 rounded-full transition-all duration-500" style="width:0%; background: linear-gradient(90deg, #93c5fd 0%, #fde68a 50%, #fca5a5 100%);"></div>
                        </div>
                        <div class="text-sm font-bold mt-1" id="temperature-percent">--</div>
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button id="update-data" type="button" class="text-white bg-[#537D5D] hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-300 font-medium rounded-full text-sm px-5 py-2.5 me-2 mb-2"><i class="fa fa-sync-alt mr-1"></i>Update Data</button>
                    <button id="get-report" type="button" class="text-white bg-[#537D5D] hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-300 font-medium rounded-full text-sm px-5 py-2.5 me-2 mb-2"><i class="fa fa-file-alt mr-1"></i>Daily Report</button>
                    <button id="get-analysis" type="button" class="text-white bg-[#537D5D] hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-300 font-medium rounded-full text-sm px-5 py-2.5 me-2 mb-2"><i class="fa fa-search mr-1"></i>Detailed Analysis</button>
                </div>
            </div>
        </div>
        <!-- Cards Row 2: Disease, Control, Disease Prediction, Status, Capture, Stream -->
        <div class="flex flex-col lg:flex-row gap-6 px-6 py-6">
            <!-- Disease Card -->
            <div class="flex-1 bg-white rounded-2xl shadow p-6 flex flex-col gap-4 min-w-[320px]">
                <div class="flex items-center gap-4 mb-2">
                    <i class="fa fa-bug text-red-300 text-3xl bg-white rounded-full border-2 border-white shadow p-2"></i>
                    <div>
                        <div class="text-lg font-bold text-gray-800">Plant Disease</div>
                        <div class="text-xs text-gray-400 italic">Prediction from ESP32-CAM</div>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-xl p-4 flex flex-col items-center shadow-sm">
                    <span class="text-xl font-bold text-red-300" id="disease-name">None</span>
                    <span class="text-xs text-gray-500 mt-1" id="disease-time">--</span>
                </div>
                <button id="get-disease" type="button" class="text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-300 font-medium rounded-full text-sm px-5 py-2.5 me-2 mb-2"><i class="fa fa-bug mr-1"></i>Get Disease Info</button>
            </div>
            <!-- Control Card -->
            <div class="flex-1 bg-white rounded-2xl shadow p-6 flex flex-col gap-4 min-w-[320px]">
                <div class="flex items-center gap-4 mb-2">
                    <i class="fa fa-tint text-blue-200 text-3xl bg-white rounded-full border-2 border-white shadow p-2"></i>
                    <div>
                        <div class="text-lg font-bold text-gray-800">Watering Control</div>
                        <div class="text-xs text-gray-400 italic">Pump & Schedule</div>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-xl p-4 flex flex-col items-center shadow-sm">
                    <span class="text-xl font-bold text-blue-300" id="pump-status">Off</span>
                    <span class="text-xs text-gray-500 mt-1" id="watering-schedule">Schedule: --</span>
                </div>
                <div class="flex gap-2 mt-2">
                    <button id="start-watering" type="button" class="text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-300 font-medium rounded-full text-sm px-5 py-2.5 me-2 mb-2"><i class="fa fa-play mr-1"></i>Start Watering</button>
                    <input type="time" id="watering-time" class="border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200">
                    <button id="set-watering-time" type="button" class="text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-300 font-medium rounded-full text-sm px-5 py-2.5 me-2 mb-2"><i class="fa fa-clock mr-1"></i>Set Schedule</button>
                </div>
            </div>
        </div>
        <!-- New API Cards Row (Prediction, Status, Capture, Stream) -->
        <div class="flex flex-col lg:flex-row gap-6 px-6 pb-8">
            <!-- Disease Prediction Card -->
            <div class="flex-1 bg-white rounded-2xl shadow p-6 flex flex-col gap-4 min-w-[320px]">
                <div class="flex items-center gap-4 mb-2">
                    <i class="fa fa-microscope text-purple-300 text-3xl bg-white rounded-full border-2 border-white shadow p-2"></i>
                    <div>
                        <div class="text-lg font-bold text-gray-800">Disease Prediction</div>
                        <div class="text-xs text-gray-400 italic">AI Model Result</div>
                    </div>
                </div>
                <button id="predict-btn" type="button" class="text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-300 font-medium rounded-full text-sm px-5 py-2.5 me-2 mb-2">Predict Disease</button>
                <div id="predict-result" class="bg-gray-50 rounded-xl p-4 mt-2 text-sm text-gray-700">
                    <span class="block text-xs text-gray-400 mb-1">Prediction:</span>
                    <span id="predicted-class" class="font-bold text-purple-700">--</span>
                    <span id="predicted-confidence" class="block text-xs text-gray-500">Confidence: --</span>
                    <span id="possible-disease" class="block text-xs text-gray-500">Possible Disease: --</span>
                    <div id="predict-meta" class="mt-2 text-xs"></div>
                    <div id="all-probabilities" class="mt-2 text-xs"></div>
                    <div id="predict-image" class="mt-2 flex justify-center"></div>
                </div>
            </div>
            <!-- Device Status Card -->
            <div class="flex-1 bg-white rounded-2xl shadow p-6 flex flex-col gap-4 min-w-[320px]">
                <div class="flex items-center gap-4 mb-2">
                    <i class="fa fa-microchip text-pink-300 text-3xl bg-white rounded-full border-2 border-white shadow p-2"></i>
                    <div>
                        <div class="text-lg font-bold text-gray-800">Device Status</div>
                        <div class="text-xs text-gray-400 italic">ESP32 Info</div>
                    </div>
                </div>
                <button id="status-btn" type="button" class="text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-300 font-medium rounded-full text-sm px-5 py-2.5 me-2 mb-2">Get Status</button>
                <div id="status-result" class="bg-gray-50 rounded-xl p-4 mt-2 text-sm text-gray-700">
                    <span class="block text-xs text-gray-400 mb-1">Status:</span>
                    <span id="device-status" class="font-bold text-pink-700">--</span>
                    <div class="mt-1 text-xs">
                        <span id="device-ip">IP: --</span><br>
                        <span id="device-ssid">SSID: --</span><br>
                        <span id="device-time">Time: --</span><br>
                        <span id="device-date">Date: --</span><br>
                        <span id="device-uptime">Uptime: --</span><br>
                        <span id="device-freeheap">Free Heap: --</span><br>
                        <span id="device-apiurl">API URL: --</span>
                    </div>
                </div>
            </div>
            <!-- Capture Image Card -->
            <div class="flex-1 bg-white rounded-2xl shadow p-6 flex flex-col gap-4 min-w-[320px]">
                <div class="flex items-center gap-4 mb-2">
                    <i class="fa fa-camera text-blue-200 text-3xl bg-white rounded-full border-2 border-white shadow p-2"></i>
                    <div>
                        <div class="text-lg font-bold text-gray-800">Capture Image</div>
                        <div class="text-xs text-gray-400 italic">Latest Photo</div>
                    </div>
                </div>
                <button id="capture-btn" type="button" class="text-white bg-gray-800 hover:bg-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-300 font-medium rounded-full text-sm px-5 py-2.5 me-2 mb-2">Capture</button>
                <div class="flex justify-center mt-2">
                    <img id="capture-image" src="http://192.168.1.65/capture-image" alt="Captured" class="rounded-xl max-h-40 object-contain border border-gray-200 bg-gray-50">
                </div>
            </div>
            <!-- Camera Stream Card -->
            <div class="flex-1 bg-white rounded-2xl shadow p-6 flex flex-col gap-4 min-w-[320px]">
                <div class="flex items-center gap-4 mb-2">
                    <i class="fa fa-video text-green-200 text-3xl bg-white rounded-full border-2 border-white shadow p-2"></i>
                    <div>
                        <div class="text-lg font-bold text-gray-800">Camera Stream</div>
                        <div class="text-xs text-gray-400 italic">Live Video</div>
                    </div>
                </div>
                <div class="flex justify-center mt-2">
                    <img id="camera-stream" src="http://192.168.1.65/stream" alt="Camera Stream" class="rounded-xl max-h-40 object-contain border border-gray-200 bg-gray-50">
                </div>
            </div>
        </div>
        <!-- Weather & Report -->
        <div class="flex flex-col lg:flex-row gap-6 px-6 pb-8">
            <div class="flex-1 bg-white rounded-2xl shadow p-6 flex flex-col gap-2 min-w-[320px]">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fa fa-cloud-sun text-blue-200"></i>
                    <span class="font-semibold text-gray-700">Weather Forecast</span>
                </div>
                <div id="weather-data" class="text-gray-600 text-sm">
                    <p>Loading weather data...</p>
                </div>
            </div>
            <div class="flex-1 bg-white rounded-2xl shadow p-6 flex flex-col gap-2 min-w-[320px]">
                <div class="flex items-center gap-2 mb-2">
                    <i class="fa fa-file-alt text-green-200"></i>
                    <span class="font-semibold text-gray-700">Daily Report</span>
                </div>
                <div id="report-data" class="text-gray-600 text-sm">
                    <p>Loading report...</p>
                </div>
            </div>
        </div>
        </main>
    </div>
    <script>
    const API_BASE = 'http://192.168.1.65';
    function updateDateTime() {
            const now = new Date();
        document.getElementById('current-date').textContent = now.toLocaleDateString('en-GB', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' });
        document.getElementById('current-time').textContent = now.toLocaleTimeString('en-GB');
    }
    setInterval(updateDateTime, 1000); updateDateTime();

    function setBar(barId, percent, valueId, percentId, value, unit) {
        const bar = document.getElementById(barId);
        const valueElem = document.getElementById(valueId);
        const percentElem = document.getElementById(percentId);
        if (bar) {
            bar.style.width = percent + '%';
            // Gradient: blue (#93c5fd) for low, yellow (#fde68a) for mid, red (#fca5a5) for high
            let color = '#93c5fd';
            if (percent < 50) color = '#93c5fd';
            else if (percent < 80) color = '#fde68a';
            else color = '#fca5a5';
            bar.style.background = `linear-gradient(90deg, #93c5fd 0%, #fde68a 50%, #fca5a5 100%)`;
            bar.style.backgroundColor = color;
        }
        if (valueElem) valueElem.textContent = value !== undefined ? value : '--';
        if (percentElem) percentElem.textContent = value !== undefined ? percent + '%' : '--';
    }

    function updateStatus() {
        fetch(`${API_BASE}/status`).then(r => r.json()).then(data => {
            // Air Humidity
            setBar('humidity-bar', data.humidity || 0, 'humidity-value', 'humidity-percent', data.humidity, '%');
            // Soil Moisture
            setBar('soil-moisture-bar', data.soil_moisture || 0, 'soil-moisture-value', 'soil-moisture-percent', data.soil_moisture, '%');
            // Temperature
            let tempPercent = data.temperature ? Math.min(100, Math.max(0, (data.temperature - 10) * 2)) : 0; // scale 10-60C to 0-100%
            setBar('temperature-bar', tempPercent, 'temperature-value', 'temperature-percent', data.temperature, '°C');
            document.getElementById('pump-status').textContent = data.pump_status === 'on' ? 'Running' : 'Off';
            document.getElementById('watering-schedule').textContent = 'Schedule: ' + (data.next_watering_time || '--');
        });
    }
    updateStatus(); setInterval(updateStatus, 10000);

    document.getElementById('update-data').onclick = function() {
        fetch(`${API_BASE}/update`).then(() => updateStatus());
    };
    document.getElementById('get-report').onclick = function() {
        fetch(`${API_BASE}/report`).then(r => r.text()).then(txt => {
            document.getElementById('report-data').innerHTML = `<pre>${txt}</pre>`;
        });
    };
    document.getElementById('get-analysis').onclick = function() {
        fetch(`${API_BASE}/analysis`).then(r => r.text()).then(txt => {
            alert('Detailed analysis:\n' + txt);
        });
    };
    document.getElementById('get-disease').onclick = function() {
        fetch(`${API_BASE}/disease`).then(r => r.json()).then(data => {
            document.getElementById('disease-name').textContent = data.name || 'None';
            document.getElementById('disease-time').textContent = data.time || '--';
            });
        };
        document.getElementById('start-watering').onclick = function() {
        fetch(`${API_BASE}/water`, {method: 'POST'}).then(() => updateStatus());
    };
    document.getElementById('set-watering-time').onclick = function() {
        const t = document.getElementById('watering-time').value;
        if (t) fetch(`${API_BASE}/setwater ` + t).then(() => updateStatus());
    };
    function updateWeather() {
        fetch(`${API_BASE}/weather`).then(r => r.text()).then(txt => {
            document.getElementById('weather-data').innerHTML = `<pre>${txt}</pre>`;
        });
    }
    updateWeather(); setInterval(updateWeather, 300000);

    // Disease Prediction API
    const predictBtn = document.getElementById('predict-btn');
    if (predictBtn) {
        predictBtn.onclick = function() {
            fetch('http://192.168.1.65/predict')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('predicted-class').textContent = data.predicted_class || '--';
                    document.getElementById('predicted-confidence').textContent = 'Confidence: ' + (data.confidence ? (data.confidence * 100).toFixed(2) + '%' : '--');
                    document.getElementById('possible-disease').textContent = 'Possible Disease: ' + (data.possible_disease ? 'Yes' : 'No');
                    // Show meta info
                    let meta = '';
                    if (data.filename) meta += `<div>Filename: <span class='font-mono'>${data.filename}</span></div>`;
                    if (data.saved_as) meta += `<div>Saved as: <span class='font-mono'>${data.saved_as}</span></div>`;
                    if (data.file_path) meta += `<div>File path: <span class='font-mono'>${data.file_path}</span></div>`;
                    document.getElementById('predict-meta').innerHTML = meta;
                    // Show all probabilities as a sorted table
                    let probs = '';
                    if (data.all_probabilities) {
                        const sorted = Object.entries(data.all_probabilities).sort((a, b) => b[1] - a[1]);
                        probs += `<table class='w-full text-xs mt-2'><thead><tr><th class='text-left'>Class</th><th class='text-right'>Probability</th></tr></thead><tbody>`;
                        for (const [k, v] of sorted) {
                            probs += `<tr><td>${k}</td><td class='text-right'>${(v * 100).toFixed(2)}%</td></tr>`;
                        }
                        probs += '</tbody></table>';
                    }
                    document.getElementById('all-probabilities').innerHTML = probs;
                    // Show predicted image if file_path is accessible
                    let imgDiv = document.getElementById('predict-image');
                    if (data.file_path) {
                        // Try to build a URL for the image (assuming / + file_path works)
                        let imgUrl = data.file_path.replace(/\\/g, '/');
                        if (!imgUrl.startsWith('/')) imgUrl = '/' + imgUrl;
                        imgDiv.innerHTML = `<img src="http://192.168.1.65${imgUrl}" alt="Prediction Image" class="rounded-xl max-h-32 border border-gray-200 bg-white">`;
                    } else {
                        imgDiv.innerHTML = '';
                    }
            });
        };
    }
    // Device Status API
    const statusBtn = document.getElementById('status-btn');
    if (statusBtn) {
        statusBtn.onclick = function() {
            fetch('http://192.168.1.65/status')
                .then(r => r.json())
                .then(data => {
                    document.getElementById('device-status').textContent = data.status || '--';
                    document.getElementById('device-ip').textContent = 'IP: ' + (data.ip || '--');
                    document.getElementById('device-ssid').textContent = 'SSID: ' + (data.ssid || '--');
                    document.getElementById('device-time').textContent = 'Time: ' + (data.time || '--');
                    document.getElementById('device-date').textContent = 'Date: ' + (data.date || '--');
                    document.getElementById('device-uptime').textContent = 'Uptime: ' + (data.uptime || '--');
                    document.getElementById('device-freeheap').textContent = 'Free Heap: ' + (data.free_heap || '--');
                    document.getElementById('device-apiurl').textContent = 'API URL: ' + (data.api_url || '--');
            });
        };
    }
    // Capture Image API
    const captureBtn = document.getElementById('capture-btn');
    if (captureBtn) {
        captureBtn.onclick = function() {
            // Reload the image to get the latest capture
            const img = document.getElementById('capture-image');
            img.src = 'http://192.168.1.65/capture-image?ts=' + Date.now();
        };
    }
    </script>
</body>
</html>