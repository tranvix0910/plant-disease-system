<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>Plant Monitor Dashboard</title>
    <style>
        body { 
            font-family: 'Inter', 'Segoe UI', 'Roboto', Arial, sans-serif; 
            overflow: hidden;
            height: 100vh;
        }
        
        .dashboard-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        
        .fixed-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .scrollable-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 20px;
        }
        
        /* Scrollbar styling */
        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .scrollable-content::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .scrollable-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .scrollable-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Card styling */
        .sensor-card {
            transition: all 0.3s ease;
        }
        
        .sensor-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        /* Bar animations */
        .bar-indicator {
            transition: width 1s ease-out, background-color 1s ease;
        }
        
        /* Button animations */
        button {
            transition: all 0.2s ease;
        }
        
        button:active {
            transform: scale(0.97);
        }
        
        /* Card animations */
        .rounded-2xl {
            transition: all 0.3s ease;
        }
        
        /* Pump animation */
        .animate-pulse {
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        /* Status changes animation */
        .status-change {
            animation: highlight 2s ease-out;
        }
        
        @keyframes highlight {
            0% {
                background-color: rgba(167, 243, 208, 0.5);
            }
            100% {
                background-color: transparent;
            }
        }
    </style>
</head>
<body class="bg-[#e6f0ea] min-h-screen text-gray-800">
<div class="dashboard-container">
    <!-- Sidebar Left -->
    <aside class="sidebar hidden md:flex flex-col w-64 bg-[#F1F1F1] px-6 py-8 justify-between shadow-md z-20">
        <div>
            <div class="flex items-center gap-3 mb-10">
                <i class="fa fa-leaf text-green-700 text-3xl"></i>
                <span class="text-2xl font-extrabold text-green-700 tracking-wide">tkplant<span class="text-green-700">.</span></span>
            </div>
            <nav class="flex flex-col gap-2">
                <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg bg-white text-green-700 font-semibold shadow-sm"><i class="fa fa-home"></i>Dashboard</a>
                <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white text-gray-600"><i class="fa fa-file-alt"></i>Report</a>
                <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white text-gray-600"><i class="fa fa-cloud-sun"></i>Forecast</a>
                <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white text-gray-600"><i class="fa fa-tint"></i>Control</a>
                <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white text-gray-600"><i class="fa fa-cog"></i>Settings</a>
                <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-white text-gray-600"><i class="fa fa-question-circle"></i>Help</a>
            </nav>
        </div>
        <div class="hidden md:block mt-10">
            <i class="fa fa-seedling text-green-400 text-6xl opacity-60 mx-auto"></i>
        </div>
    </aside>
    <!-- Main Content -->
    <main class="main-content flex-1 flex flex-col bg-[#F1F1F1]">
        <!-- Header -->
        <header class="fixed-header flex flex-col md:flex-row items-center justify-between px-6 py-6 bg-[#F1F1F1] border-b border-gray-200 shadow-sm">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Welcome, <span class="text-green-700">User!</span></h2>
                <div class="flex items-center gap-2 text-gray-400 text-sm mt-1">
                    <span id="current-date"></span>
                <span id="current-time"></span>
                    <span id="status-badge" class="ml-2 inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700"><i class="fa fa-circle mr-1 text-green-500"></i>Online</span>
                </div>
            </div>
            <div class="flex items-center gap-3 mt-4 md:mt-0">
                <button class="bg-white p-2 rounded-full shadow hover:bg-gray-100"><i class="fa fa-search text-gray-500"></i></button>
                <button class="bg-white p-2 rounded-full shadow hover:bg-gray-100"><i class="fa fa-bell text-gray-500"></i></button>
            </div>
        </header>
        
        <!-- Notification Area -->
        <div id="notification-area" class="px-6 py-2 hidden">
            <div class="w-full bg-[#537D5D] text-white px-4 py-3 rounded-lg shadow-md flex items-center transition-all duration-300">
                <i class="fa fa-check-circle mr-2"></i>
                <span id="notification-message">Notification will appear here</span>
                <button class="ml-auto text-white hover:text-gray-200" onclick="hideNotification()">
                    <i class="fa fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- Scrollable Content -->
        <div class="scrollable-content pt-4">
        <!-- Sensor Card Row (Full Width) -->
        <div class="px-6 pt-6">
                <div class="w-full bg-white rounded-2xl shadow-md p-6 flex flex-col gap-4 min-w-[320px] hover:shadow-lg transition-all duration-300">
                    <h3 class="text-xl font-bold text-gray-700 flex items-center"><i class="fa fa-chart-line text-green-600 mr-2"></i>Sensor Readings</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mt-2">
                    <!-- Air Humidity Card -->
                        <div class="sensor-card bg-gray-50 rounded-xl p-4 flex flex-col gap-2 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fa fa-tint text-[#537D5D] text-4xl p-6"></i>
                                <div>
                                    <div class="text-2xl font-bold text-gray-800" id="humidity-value">{{HUMIDITY}}</div>
                                    <div class="text-sm text-gray-400">Air Humidity</div>
                                </div>
                            </div>
                            <i class="fa fa-arrow-up text-green-400"></i>
                        </div>
                            <div class="w-full h-4 bg-gray-200 rounded-full mt-2">
                                <div id="humidity-bar" class="bar-indicator h-4 rounded-full transition-all duration-500"></div>
                        </div>
                        <div class="text-sm font-bold mt-1" id="humidity-percent">{{HUMIDITY}}%</div>
                    </div>
                    <!-- Soil Moisture Card -->
                        <div class="sensor-card bg-gray-50 rounded-xl p-4 flex flex-col gap-2 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fa fa-water text-[#537D5D] text-4xl p-6"></i>
                                <div>
                                    <div class="text-2xl font-bold text-gray-800" id="soil-moisture-value">{{SOIL_MOISTURE}}</div>
                                    <div class="text-sm text-gray-400">Soil Moisture</div>
                                </div>
                            </div>
                            <i class="fa fa-arrow-up text-green-400"></i>
                        </div>
                            <div class="w-full h-4 bg-gray-200 rounded-full mt-2">
                                <div id="soil-moisture-bar" class="bar-indicator h-4 rounded-full transition-all duration-500"></div>
                        </div>
                        <div class="text-sm font-bold mt-1" id="soil-moisture-percent">{{SOIL_MOISTURE}}%</div>
                    </div>
                    <!-- Temperature Card -->
                        <div class="sensor-card bg-gray-50 rounded-xl p-4 flex flex-col gap-2 shadow-sm">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="fa fa-thermometer-half text-[#537D5D] text-4xl p-6"></i>
                                <div>
                                    <div class="text-2xl font-bold text-gray-800" id="temperature-value">{{TEMPERATURE}}</div>
                                    <div class="text-sm text-gray-400">Temperature</div>
                                </div>
                            </div>
                            <i class="fa fa-arrow-up text-green-400"></i>
                        </div>
                            <div class="w-full h-4 bg-gray-200 rounded-full mt-2">
                                <div id="temperature-bar" class="bar-indicator h-4 rounded-full transition-all duration-500"></div>
                        </div>
                        <div class="text-sm font-bold mt-1" id="temperature-percent">{{TEMPERATURE}}¬∞C</div>
                    </div>
                </div>
                    <div class="flex flex-wrap gap-2 mt-4">
                        <button id="update-data" type="button" class="text-white bg-[#537D5D] hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 font-medium rounded-full text-sm px-5 py-2.5 me-2 mb-2 transition-all duration-300"><i class="fa fa-sync-alt mr-1"></i>Update Data</button>
                        <button id="update-sheets" type="button" class="text-white bg-[#537D5D] hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 font-medium rounded-full text-sm px-5 py-2.5 me-2 mb-2 transition-all duration-300"><i class="fa fa-cloud-upload-alt mr-1"></i>Update To Google Sheets</button>
                        <button id="get-report" type="button" class="text-white bg-[#537D5D] hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 font-medium rounded-full text-sm px-5 py-2.5 me-2 mb-2 transition-all duration-300"><i class="fa fa-file-alt mr-1"></i>Daily Report</button>
                        <button id="get-analysis" type="button" class="text-white bg-[#537D5D] hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300 font-medium rounded-full text-sm px-5 py-2.5 me-2 mb-2 transition-all duration-300"><i class="fa fa-search mr-1"></i>Detailed Analysis</button>
                    </div>
                </div>
            </div>
            <!-- Cards Row 2: Disease, Control, Disease Prediction, Status, Capture, Stream -->
            <div class="flex flex-col lg:flex-row gap-6 px-6 py-6">
            <!-- Watering Control Card -->
            <div class="flex-1 bg-white rounded-2xl shadow-md p-6 flex flex-col gap-4 min-w-[320px] hover:shadow-lg transition-all duration-300">
                <div class="flex items-center gap-4 mb-2">
                    <i class="fa fa-tint text-blue-500 text-3xl bg-blue-100 rounded-full border-2 border-blue-200 shadow p-4"></i>
                    <div>
                        <div class="text-lg font-bold text-gray-800">Watering Control</div>
                        <div class="text-xs text-gray-500">Smart Pump & Scheduling System</div>
                    </div>
                </div>
                <div class="bg-gray-50 rounded-xl p-4 flex flex-col items-center shadow-sm">
                    <div class="flex justify-center items-center gap-3">
                        <i id="pump-icon" class="fa fa-power-off text-gray-400 text-2xl"></i>
                        <span class="text-xl font-bold text-gray-700" id="pump-status">Off</span>
                    </div>
                    <div class="mt-2 text-sm text-gray-600 flex items-center gap-2">
                        <i class="fa fa-clock text-blue-400"></i>
                        <span id="watering-schedule">Next watering: --</span>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 mt-2">
                    <button id="start-watering" type="button" class="text-white bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 transition-all duration-300">
                        <i class="fa fa-play mr-1"></i>Start Watering
                    </button>
                    <input type="time" id="watering-time" class="border rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-200">
                    <button id="set-watering-time" type="button" class="text-white bg-gray-700 hover:bg-gray-800 focus:outline-none focus:ring-4 focus:ring-gray-300 font-medium rounded-lg text-sm px-5 py-2.5 transition-all duration-300">
                        <i class="fa fa-clock mr-1"></i>Set Schedule
                    </button>
                </div>
            </div>
            
            <!-- Disease Prediction Card -->
            <div class="flex-1 bg-white rounded-2xl shadow-md p-6 flex flex-col gap-4 min-w-[320px] hover:shadow-lg transition-all duration-300">
                <div class="flex items-center gap-4 mb-2">
                    <i class="fa fa-microscope text-purple-500 text-3xl bg-purple-100 rounded-full border-2 border-purple-200 shadow p-4"></i>
                    <div>
                        <div class="text-lg font-bold text-gray-800">Disease Prediction</div>
                        <div class="text-xs text-gray-500">AI-Powered Plant Health Analysis</div>
                    </div>
                </div>
                <button id="predict-btn" type="button" class="text-white bg-purple-500 hover:bg-purple-600 focus:outline-none focus:ring-4 focus:ring-purple-300 font-medium rounded-lg text-sm px-5 py-2.5 transition-all duration-300">
                    <i class="fa fa-search mr-1"></i>Predict Disease
                </button>
                <div id="predict-result" class="bg-gray-50 rounded-xl p-4 mt-2">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fa fa-leaf text-green-500"></i>
                        <h3 class="font-bold text-gray-700">Plant Health Status</h3>
                    </div>
                    <div class="border-b border-gray-200 pb-2 mb-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Status:</span>
                            <span id="predicted-class" class="font-bold text-purple-700">--</span>
                        </div>
                    </div>
                    <div class="border-b border-gray-200 pb-2 mb-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Confidence:</span>
                            <span id="predicted-confidence" class="text-gray-700">--</span>
                        </div>
                    </div>
                    <div class="border-b border-gray-200 pb-2 mb-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Possible Disease:</span>
                            <span id="possible-disease" class="text-gray-700">--</span>
                        </div>
                    </div>
                    <div id="predict-meta" class="mt-2 text-xs text-gray-500"></div>
                    <div id="all-probabilities" class="mt-2 text-xs text-gray-500"></div>
                    <div id="predict-image" class="mt-3 flex justify-center"></div>
                </div>
            </div>
            
            <!-- Device Status Card -->
            <div class="flex-1 bg-white rounded-2xl shadow-md p-6 flex flex-col gap-4 min-w-[320px] hover:shadow-lg transition-all duration-300">
                <div class="flex items-center gap-4 mb-2">
                    <i class="fa fa-microchip text-green-500 text-3xl bg-green-100 rounded-full border-2 border-green-200 shadow p-4"></i>
                    <div>
                        <div class="text-lg font-bold text-gray-800">Device Status</div>
                        <div class="text-xs text-gray-500">ESP32 System Information</div>
                    </div>
                </div>
                <button id="status-btn" type="button" class="text-white bg-green-500 hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 transition-all duration-300">
                    <i class="fa fa-sync-alt mr-1"></i>Get Status
                </button>
                <div id="status-result" class="bg-gray-50 rounded-xl p-4 mt-2">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="fa fa-info-circle text-green-500"></i>
                        <h3 class="font-bold text-gray-700">System Information</h3>
                    </div>
                    <div class="border-b border-gray-200 pb-2 mb-2">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-600">Status:</span>
                            <span id="device-status" class="font-bold text-green-700">--</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mt-2">
                        <div class="flex items-center gap-2">
                            <i class="fa fa-network-wired text-gray-400 text-xs"></i>
                            <span id="device-ip" class="text-xs text-gray-700">IP: --</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fa fa-wifi text-gray-400 text-xs"></i>
                            <span id="device-ssid" class="text-xs text-gray-700">SSID: --</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fa fa-clock text-gray-400 text-xs"></i>
                            <span id="device-time" class="text-xs text-gray-700">Time: --</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fa fa-calendar text-gray-400 text-xs"></i>
                            <span id="device-date" class="text-xs text-gray-700">Date: --</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fa fa-hourglass-half text-gray-400 text-xs"></i>
                            <span id="device-uptime" class="text-xs text-gray-700">Uptime: --</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fa fa-memory text-gray-400 text-xs"></i>
                            <span id="device-freeheap" class="text-xs text-gray-700">Free Heap: --</span>
                        </div>
                        <div class="flex items-center gap-2 col-span-2">
                            <i class="fa fa-link text-gray-400 text-xs"></i>
                            <span id="device-apiurl" class="text-xs text-gray-700">API URL: --</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Capture and Stream Cards Row -->
        <div class="flex flex-col lg:flex-row gap-6 px-6 pb-8">
            <!-- Capture Image Card -->
            <div class="flex-1 bg-white rounded-2xl shadow-md p-6 flex flex-col gap-4 min-w-[320px] hover:shadow-lg transition-all duration-300">
                <div class="flex items-center gap-4 mb-2">
                    <i class="fa fa-camera text-blue-500 text-3xl bg-blue-100 rounded-full border-2 border-blue-200 shadow p-4"></i>
                    <div>
                        <div class="text-lg font-bold text-gray-800">Capture Image</div>
                        <div class="text-xs text-gray-500">Latest Plant Photo</div>
                    </div>
                </div>
                <button id="capture-btn" type="button" class="text-white bg-blue-500 hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 transition-all duration-300">
                    <i class="fa fa-camera mr-1"></i>Capture Photo
                </button>
                <div class="flex justify-center mt-2">
                    <img id="capture-image" src="image.png" alt="Captured" class="rounded-xl h-48 object-contain border border-gray-200 bg-gray-50">
                </div>
            </div>
            
            <!-- Camera Stream Card -->
            <div class="flex-1 bg-white rounded-2xl shadow-md p-6 flex flex-col gap-4 min-w-[320px] hover:shadow-lg transition-all duration-300">
                <div class="flex items-center gap-4 mb-2">
                    <i class="fa fa-video text-green-500 text-3xl bg-green-100 rounded-full border-2 border-green-200 shadow p-4"></i>
                    <div>
                        <div class="text-lg font-bold text-gray-800">Camera Stream</div>
                        <div class="text-xs text-gray-500">Live Plant Monitoring</div>
                    </div>
                </div>
                <div class="flex justify-center mt-2">
                    <img id="camera-stream" src="image.png" alt="Camera Stream" class="rounded-xl h-48 object-contain border border-gray-200 bg-gray-50">
                </div>
            </div>
        </div>
        </main>
</div>

<!-- Modal Dialog -->
<div id="modal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
    <div class="absolute inset-0 bg-black bg-opacity-50"></div>
    <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-2xl max-h-[80vh] overflow-y-auto z-10 relative">
        <div class="flex justify-between items-center mb-4">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800">Report</h3>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div id="modal-content" class="text-gray-700 text-sm whitespace-pre-wrap"></div>
        <div id="modal-loading" class="hidden">
            <div class="flex items-center justify-center py-4">
                <i class="fa fa-spinner fa-spin text-[#537D5D] text-2xl mr-2"></i>
                <span class="text-gray-700">Loading results...</span>
            </div>
        </div>
        <div class="mt-6 flex justify-end">
            <button onclick="closeModal()" class="bg-[#537D5D] text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all duration-300">Close</button>
        </div>
    </div>
</div>

<script>
    const API_URL = ''; // API calls disabled ‚Äì demo mode
    const API_URL_ESP32_CAM = '';
    /* ---------- SAMPLE DATA FOR DEMO ---------- */
    const sampleData = {
        temperature: 25.4,
        humidity: 60.5,
        soil_moisture: 45,
        pump_status: 'off',
        next_watering_time: '17:00'
    };
    function updateDateTime() {
            const now = new Date();
        document.getElementById('current-date').textContent = now.toLocaleDateString('en-GB', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' });
        document.getElementById('current-time').textContent = now.toLocaleTimeString('en-GB');
    }
    setInterval(updateDateTime, 1000); updateDateTime();

    function showNotification(message, type = 'success') {
        const notificationArea = document.getElementById('notification-area');
        const notificationMessage = document.getElementById('notification-message');
        
        // Set the message
        notificationMessage.textContent = message;
        
        // Get the notification div (parent of the message)
        const notificationDiv = notificationMessage.parentElement;
        
        // Reset all classes
        notificationDiv.className = 'w-full px-4 py-3 rounded-lg shadow-md flex items-center transition-all duration-300';
        
        // Set the appropriate class based on type
        if (type === 'success') {
            notificationDiv.classList.add('bg-[#537D5D]', 'text-white');
            notificationMessage.previousElementSibling.className = 'fa fa-check-circle mr-2';
        } else if (type === 'error') {
            notificationDiv.classList.add('bg-red-500', 'text-white');
            notificationMessage.previousElementSibling.className = 'fa fa-exclamation-circle mr-2';
        } else if (type === 'info') {
            notificationDiv.classList.add('bg-blue-500', 'text-white');
            notificationMessage.previousElementSibling.className = 'fa fa-info-circle mr-2';
        }
        
        // Show the notification
        notificationArea.classList.remove('hidden');
        
        // Set a timeout to hide the notification after 5 seconds
        setTimeout(hideNotification, 5000);
    }

    // H√†m ·∫©n th√¥ng b√°o
    function hideNotification() {
        document.getElementById('notification-area').classList.add('hidden');
    }

    function setBar(barId, percent, valueId, percentId, value, unit) {
        const bar = document.getElementById(barId);
        const valueElem = document.getElementById(valueId);
        const percentElem = document.getElementById(percentId);
        
        // Handle undefined or null values
        if (value === undefined || value === null) {
            value = '--';
            percent = 0;
        }
        
        if (bar) {
            bar.style.width = percent + '%';
        
            // X·ª≠ l√Ω m√†u d·ª±a tr√™n gi√° tr·ªã c·∫£m bi·∫øn
            let color;
            if (barId === 'temperature-bar') {
                // Nhi·ªát ƒë·ªô: xanh khi l·∫°nh -> v√†ng -> ƒë·ªè khi n√≥ng
                if (value < 18) {
                    color = '#3b82f6'; // xanh d∆∞∆°ng
                } else if (value < 22) {
                    color = '#60a5fa'; // xanh d∆∞∆°ng nh·∫°t
                } else if (value < 26) {
                    color = '#10b981'; // xanh l√°
                } else if (value < 30) {
                    color = '#facc15'; // v√†ng
                } else if (value < 34) {
                    color = '#f97316'; // cam
                } else {
                    color = '#ef4444'; // ƒë·ªè
                }
            } 
            else if (barId === 'humidity-bar') {
                // ƒê·ªô ·∫©m kh√¥ng kh√≠: ƒë·ªè khi kh√¥ -> v√†ng -> xanh khi ·∫©m
                if (percent < 30) {
                    color = '#ef4444'; // ƒë·ªè - qu√° kh√¥
                } else if (percent < 45) {
                    color = '#f97316'; // cam - h∆°i kh√¥
                } else if (percent < 60) {
                    color = '#10b981'; // xanh l√° - t·ªët
                } else if (percent < 75) {
                    color = '#60a5fa'; // xanh d∆∞∆°ng nh·∫°t - h∆°i ·∫©m
                } else {
                    color = '#3b82f6'; // xanh d∆∞∆°ng - qu√° ·∫©m
                }
            }
            else if (barId === 'soil-moisture-bar') {
                // ƒê·ªô ·∫©m ƒë·∫•t: ƒë·ªè khi kh√¥ -> v√†ng -> xanh khi ·∫©m
                if (percent < 20) {
                    color = '#ef4444'; // ƒë·ªè - qu√° kh√¥
                } else if (percent < 35) {
                    color = '#f97316'; // cam - h∆°i kh√¥
                } else if (percent < 60) {
                    color = '#10b981'; // xanh l√° - t·ªët
                } else if (percent < 80) {
                    color = '#60a5fa'; // xanh d∆∞∆°ng nh·∫°t - h∆°i ·∫©m
                } else {
                    color = '#3b82f6'; // xanh d∆∞∆°ng - qu√° ·∫©m
                }
            }
            
            bar.style.backgroundColor = color;
        }
        
        if (valueElem) {
            const oldValue = valueElem.textContent;
            valueElem.textContent = value;
            // Add animation if value has changed
            if (oldValue !== value.toString()) {
                animateStatusChange(valueElem);
            }
        }
        
        if (percentElem) {
            if (value === '--') {
                percentElem.textContent = '--';
            } else if (unit === '¬∞C') {
                // Handle temperature display
                percentElem.textContent = value + unit;
            } else {
                // Handle percentage displays
                percentElem.textContent = percent + '%';
            }
        }
    }
    
    // Function to add highlight animation to updated elements
    function animateStatusChange(element) {
        // Remove the class if it's already there
        element.classList.remove('status-change');
        
        // Force a reflow to restart the animation
        void element.offsetWidth;
        
        // Add the class back to trigger the animation
        element.classList.add('status-change');
        
        // Remove class after animation completes
        setTimeout(() => {
            element.classList.remove('status-change');
        }, 2000);
    }

    // Add spinner to button
    function addSpinner(button) {
        // Save original content
        button.dataset.originalContent = button.innerHTML;
        // Replace with spinner
        const icon = button.querySelector('i') || document.createElement('i');
        icon.className = 'fa fa-spinner fa-spin mr-1';
        button.innerHTML = '';
        button.appendChild(icon);
        button.appendChild(document.createTextNode(' ƒêang c·∫≠p nh·∫≠t...'));
        button.disabled = true;
    }

    // Restore button state
    function removeSpinner(button) {
        if (button.dataset.originalContent) {
            button.innerHTML = button.dataset.originalContent;
            button.disabled = false;
        }
        }

    function updateStatus() {
        const data = sampleData; // use demo data instead of calling API
        return Promise.resolve(data).then(data => {
            // Air Humidity
            setBar('humidity-bar', data.humidity || 0, 'humidity-value', 'humidity-percent', data.humidity, '%');
            // Soil Moisture
            setBar('soil-moisture-bar', data.soil_moisture || 0, 'soil-moisture-value', 'soil-moisture-percent', data.soil_moisture, '%');
            // Temperature
            let tempPercent = data.temperature ? Math.min(100, Math.max(0, (data.temperature - 10) * 3.33)) : 0; // scale 10-40C to 0-100%
            setBar('temperature-bar', tempPercent, 'temperature-value', 'temperature-percent', data.temperature, '¬∞C');
            
            // Update pump status with visual indicator
            const pumpStatus = data.pump_status === 'on' ? 'Running' : 'Off';
            document.getElementById('pump-status').textContent = pumpStatus;
            
            // Update pump icon based on status
            const pumpIcon = document.getElementById('pump-icon');
            if (data.pump_status === 'on') {
                pumpIcon.className = 'fa fa-power-off text-blue-500 text-2xl';
                pumpIcon.classList.add('animate-pulse');
            } else {
                pumpIcon.className = 'fa fa-power-off text-gray-400 text-2xl';
                pumpIcon.classList.remove('animate-pulse');
            }
            
            // Update watering schedule with better formatting
            document.getElementById('watering-schedule').textContent = data.next_watering_time ? `Next watering: ${data.next_watering_time}` : 'No schedule set';
            
            return data;
        });
    }

    // We don't call updateStatus automatically anymore, only on button click
    // Initial data loading to show something when the page loads
    updateStatus();

    // First update button - Just update local display data
    document.getElementById('update-data').onclick = function() {
        const button = this;
        addSpinner(button);
        
        updateStatus()
            .then(() => {
                showNotification('Data updated successfully!', 'success');
            })
            .catch(() => {
                showNotification('Error updating data!', 'error');
            })
            .finally(() => {
                removeSpinner(button);
            });
    };

    // Second update button - Send data to Google Sheets
    document.getElementById('update-sheets').onclick = function() {
        showNotification('Cloud sync disabled in demo mode.', 'info');
    };

    // Add modal functions
    function showModal(title, content) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-content').textContent = content;
        document.getElementById('modal').classList.remove('hidden');
        document.getElementById('modal-loading').classList.add('hidden');
        // Prevent body scrolling when modal is open
        document.body.style.overflow = 'hidden';
    }

    function showModalWithHTML(title, htmlContent) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-content').innerHTML = htmlContent;
        document.getElementById('modal').classList.remove('hidden');
        document.getElementById('modal-loading').classList.add('hidden');
        // Prevent body scrolling when modal is open
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        document.getElementById('modal').classList.add('hidden');
        // Re-enable body scrolling
        document.body.style.overflow = 'auto';
        // Clear any auto-check intervals
        if (window.analysisCheckInterval) {
            clearInterval(window.analysisCheckInterval);
            window.analysisCheckInterval = null;
        }
        if (window.reportCheckInterval) {
            clearInterval(window.reportCheckInterval);
            window.reportCheckInterval = null;
        }
    }

    // Function to format analysis text for better presentation
    function formatAnalysisOutput(text) {
        if (!text) return '<p>No results available</p>';
        
        // Replace line breaks with HTML line breaks
        let html = text.replace(/\n/g, '<br>');
        
        // Highlight sections (headers with emojis)
        html = html.replace(/üìä ([^<]+)/g, '<h3 class="text-lg font-bold text-[#537D5D] mt-4 mb-2">üìä $1</h3>');
        html = html.replace(/üå°Ô∏è ([^<]+)/g, '<h4 class="font-bold text-[#537D5D] mt-3 mb-1">üå°Ô∏è $1</h4>');
        html = html.replace(/üíß ([^<]+)/g, '<h4 class="font-bold text-[#537D5D] mt-3 mb-1">üíß $1</h4>');
        html = html.replace(/üå± ([^<]+)/g, '<h4 class="font-bold text-[#537D5D] mt-3 mb-1">üå± $1</h4>');
        html = html.replace(/üìù ([^<]+)/g, '<h4 class="font-bold text-[#537D5D] mt-3 mb-1">üìù $1</h4>');
        html = html.replace(/üí° ([^<]+)/g, '<h4 class="font-bold text-[#537D5D] mt-3 mb-1">üí° $1</h4>');
        html = html.replace(/‚ö†Ô∏è ([^<]+)/g, '<div class="text-orange-500 mt-2">‚ö†Ô∏è $1</div>');
        html = html.replace(/‚úÖ ([^<]+)/g, '<div class="text-green-600 mt-2">‚úÖ $1</div>');
        html = html.replace(/üîÆ ([^<]+)/g, '<h4 class="font-bold text-[#537D5D] mt-3 mb-1">üîÆ $1</h4>');
        
        // Format bullets
        html = html.replace(/‚Ä¢(.*?)(?=<br>|$)/g, '<li class="ml-5">$1</li>');
        
        return html;
    }

    document.getElementById('get-report').onclick = function() {
        const button = this;
        addSpinner(button);
        
        // Sample daily report content
        const sampleReport = `üìä B√ÅO C√ÅO PH√ÇN T√çCH üìä

üìÖ Ng√†y: 2025-01-15
üå°Ô∏è Nhi·ªát ƒë·ªô: 25.4¬∞C (TB), 26.1¬∞C (Max), 24.8¬∞C (Min)
üíß ƒê·ªô ·∫©m kh√¥ng kh√≠ TB: 60.5%
üå± ƒê·ªô ·∫©m ƒë·∫•t TB: 45.0%

Ng√†y 2025-01-15, nhi·ªát ƒë·ªô trung b√¨nh 25.4¬∞C (dao ƒë·ªông nh·ªè), ƒë·ªô ·∫©m kh√¥ng kh√≠ trung b√¨nh 60.5%, cho th·∫•y th·ªùi ti·∫øt √¥n h√≤a v√† kh√¥ r√°o. üå± ƒê·ªô ·∫©m ƒë·∫•t trung b√¨nh 45.0% ·ªü m·ª©c trung b√¨nh, cho th·∫•y s·ª± ph√¢n b·ªë n∆∞·ªõc t∆∞∆°ng ƒë·ªëi ·ªïn ƒë·ªãnh.

ƒê·ªëi v·ªõi c√¢y tr·ªìng, nhi·ªát ƒë·ªô kh√° l√Ω t∆∞·ªüng, ƒë·ªô ·∫©m ƒë·∫•t ·ªü m·ª©c ph√π h·ª£p. üå± ƒê·ªô ·∫©m ƒë·∫•t ·ªïn ƒë·ªãnh gi√∫p c√¢y ph√°t tri·ªÉn t·ªët v√† gi·∫£m nguy c∆° s√¢u b·ªánh.

üí° ƒê·ªÅ xu·∫•t: Duy tr√¨ ch·∫ø ƒë·ªô t∆∞·ªõi hi·ªán t·∫°i. Theo d√µi ƒë·ªô ·∫©m ƒë·∫•t th∆∞·ªùng xuy√™n ƒë·ªÉ ƒë·∫£m b·∫£o kh√¥ng b·ªã kh√¥ h·∫°n. Ki·ªÉm tra c√¢y ƒë·ªãnh k·ª≥ ƒë·ªÉ ph√°t hi·ªán s·ªõm c√°c d·∫•u hi·ªáu b·∫•t th∆∞·ªùng.

‚úÖ T√¨nh tr·∫°ng t·ªïng th·ªÉ: T√¨nh tr·∫°ng t·ªët, c√¢y kh·ªèe m·∫°nh`;

        setTimeout(() => {
            removeSpinner(button);
            showNotification('Daily report generated successfully!', 'success');
            showModalWithHTML('Daily Report', formatAnalysisOutput(sampleReport));
        }, 1000);
    };

    document.getElementById('get-analysis').onclick = function() {
        const button = this;
        addSpinner(button);
        
        // Sample detailed analysis content
        const sampleAnalysis = `üìä PH√ÇN T√çCH CHI TI·∫æT üìä

                                üìÖ Ng√†y ph√¢n t√≠ch: 2025-01-15
                                üïê Th·ªùi gian: 14:30

                                üå°Ô∏è PH√ÇN T√çCH NHI·ªÜT ƒê·ªò
                                ‚Ä¢ Nhi·ªát ƒë·ªô hi·ªán t·∫°i: 25.4¬∞C
                                ‚Ä¢ Nhi·ªát ƒë·ªô t·ªëi ∆∞u cho c√¢y: 22-28¬∞C
                                ‚Ä¢ ƒê√°nh gi√°: Nhi·ªát ƒë·ªô trong kho·∫£ng l√Ω t∆∞·ªüng
                                ‚Ä¢ Xu h∆∞·ªõng: ·ªîn ƒë·ªãnh trong 24h qua

                                üíß PH√ÇN T√çCH ƒê·ªò ·∫®M KH√îNG KH√ç
                                ‚Ä¢ ƒê·ªô ·∫©m hi·ªán t·∫°i: 60.5%
                                ‚Ä¢ ƒê·ªô ·∫©m t·ªëi ∆∞u: 50-70%
                                ‚Ä¢ ƒê√°nh gi√°: ƒê·ªô ·∫©m ph√π h·ª£p
                                ‚Ä¢ T√°c ƒë·ªông: Gi√∫p c√¢y h·∫•p th·ª• n∆∞·ªõc t·ªët

                                üå± PH√ÇN T√çCH ƒê·ªò ·∫®M ƒê·∫§T
                                ‚Ä¢ ƒê·ªô ·∫©m ƒë·∫•t hi·ªán t·∫°i: 45%
                                ‚Ä¢ Ng∆∞·ª°ng t∆∞·ªõi n∆∞·ªõc: < 30%
                                ‚Ä¢ ƒê√°nh gi√°: ƒê·ªô ·∫©m ƒë·∫•t ·ªü m·ª©c trung b√¨nh
                                ‚Ä¢ Khuy·∫øn ngh·ªã: Theo d√µi v√† t∆∞·ªõi khi c·∫ßn

                                üîÆ D·ª∞ B√ÅO V√Ä KHUY·∫æN NGH·ªä
                                ‚Ä¢ Th·ªùi ti·∫øt d·ª± b√°o: ·ªîn ƒë·ªãnh trong 3 ng√†y t·ªõi
                                ‚Ä¢ L·ªãch t∆∞·ªõi ti·∫øp theo: 17:00 h√¥m nay
                                ‚Ä¢ Nguy c∆° s√¢u b·ªánh: Th·∫•p
                                ‚Ä¢ T√¨nh tr·∫°ng t·ªïng th·ªÉ: T·ªët

                                üí° H√ÄNH ƒê·ªòNG ƒê·ªÄ XU·∫§T
                                ‚úÖ Duy tr√¨ l·ªãch t∆∞·ªõi hi·ªán t·∫°i
                                ‚úÖ Ki·ªÉm tra c√¢y h√†ng ng√†y
                                ‚úÖ Theo d√µi ƒë·ªô ·∫©m ƒë·∫•t
                                ‚ö†Ô∏è Chu·∫©n b·ªã ph√≤ng ch·ªëng s√¢u b·ªánh m√πa m∆∞a`;

        setTimeout(() => {
            removeSpinner(button);
            showNotification('Detailed analysis completed successfully!', 'success');
            showModalWithHTML('Detailed Analysis', formatAnalysisOutput(sampleAnalysis));
        }, 1500);
    };

    document.getElementById('start-watering').onclick = function() {
    const button = this;
    addSpinner(button);
    
    setTimeout(() => {
        const pumpStatus = document.getElementById('pump-status');
        const pumpIcon = document.getElementById('pump-icon');
        
        pumpStatus.textContent = 'Running';
        pumpStatus.classList.add('text-blue-500');
        animateStatusChange(pumpStatus);
        
        pumpIcon.className = 'fa fa-power-off text-blue-500 text-2xl';
        pumpIcon.classList.add('animate-pulse');
        
        showNotification('Watering started and will run for 10 seconds!', 'success');
        removeSpinner(button);
        
        // Update UI after watering completes (10 seconds)
        setTimeout(() => {
            pumpStatus.textContent = 'Off';
            pumpStatus.classList.remove('text-blue-500');
            animateStatusChange(pumpStatus);
            
            pumpIcon.className = 'fa fa-power-off text-gray-400 text-2xl';
            pumpIcon.classList.remove('animate-pulse');
            
            showNotification('Watering completed!', 'success');
        }, 10000); // 10 seconds watering simulation
        
    }, 1000);
};

document.getElementById('set-watering-time').onclick = function() {
    const button = this;
        const selectedTime = document.getElementById('watering-time').value;
    
    if (!selectedTime) {
        showNotification('Please select a watering time!', 'error');
        return;
    }
    
    addSpinner(button);
    
    // Demo mode - simulate setting schedule
    setTimeout(() => {
        // Immediately update UI to show new schedule
        const scheduleElement = document.getElementById('watering-schedule');
        scheduleElement.textContent = `Next watering: ${selectedTime}`;
        animateStatusChange(scheduleElement);
        
        // Update sample data
        sampleData.next_watering_time = selectedTime;
        
        showNotification(`Watering schedule set for ${selectedTime}`, 'success');
        removeSpinner(button);
    }, 1000);
};

    function updateWeather() {
        fetch(`${API_URL}/weather`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('weather-icon').className = 'fa fa-' + weatherIcons[data.icon] || 'fa fa-sun-o';
                document.getElementById('weather-temp').textContent = data.temperature;
                document.getElementById('weather-desc').textContent = data.description;
                document.getElementById('weather-location').textContent = data.location;
                document.getElementById('weather-update-time').textContent = data.lastUpdated;
            })
            .catch(error => {
                console.error('Error fetching weather data:', error);
                showNotification('Error fetching weather data: ' + error.message, 'error');
            });
    }
    updateWeather(); setInterval(updateWeather, 300000);

    // Disease Prediction API
    const predictBtn = document.getElementById('predict-btn');
    if (predictBtn) {
        predictBtn.onclick = function() {
        const button = this;
        addSpinner(button);
        
        // Sample prediction data
        const samplePredictions = [
            {
                predicted_class: 'Healthy',
                confidence: '92.5%',
                disease: 'No disease detected',
                probabilities: {
                    'Healthy': '92.5',
                    'Bacterial Spot': '4.2',
                    'Early Blight': '2.1',
                    'Late Blight': '1.2'
                },
                metadata: 'Plant appears healthy with good leaf color and structure. No visible signs of disease or pest damage.'
            },
            {
                predicted_class: 'Early Blight',
                confidence: '87.3%',
                disease: 'Early Blight Disease',
                probabilities: {
                    'Early Blight': '87.3',
                    'Late Blight': '8.1',
                    'Healthy': '3.2',
                    'Bacterial Spot': '1.4'
                },
                metadata: 'Detected brown spots with concentric rings on leaves. Early intervention recommended.'
            },
            {
                predicted_class: 'Bacterial Spot',
                confidence: '79.8%',
                disease: 'Bacterial Spot Disease',
                probabilities: {
                    'Bacterial Spot': '79.8',
                    'Early Blight': '12.5',
                    'Healthy': '5.2',
                    'Late Blight': '2.5'
                },
                metadata: 'Small dark spots with yellow halos detected on leaves. Bacterial infection likely.'
            }
        ];
        
        // Randomly select one of the sample predictions
        const randomPrediction = samplePredictions[Math.floor(Math.random() * samplePredictions.length)];
        
        setTimeout(() => {
            document.getElementById('predicted-class').textContent = randomPrediction.predicted_class || '--';
            document.getElementById('predicted-confidence').textContent = randomPrediction.confidence || '--';
            document.getElementById('possible-disease').textContent = randomPrediction.disease || '--';
            
            const statusElement = document.getElementById('predicted-class');
            if (randomPrediction.predicted_class) {
                if (randomPrediction.predicted_class.toLowerCase().includes('healthy')) {
                    statusElement.className = 'font-bold text-green-600';
                } else {
                    statusElement.className = 'font-bold text-red-600';
                }
            }
            
            showNotification('Disease prediction completed!', 'success');
            removeSpinner(button);
        }, 1500);
        };
    }
    
    // Device Status API
    const statusBtn = document.getElementById('status-btn');
    if (statusBtn) {
        statusBtn.onclick = function() {
            const button = this;
            addSpinner(button);
            
            // Sample device status data
            const sampleStatus = {
                status: 'Online',
                ip: '192.168.1.100',
                ssid: 'PlantNetwork_2.4G',
                time: new Date().toLocaleTimeString('en-GB'),
                date: new Date().toLocaleDateString('en-GB'),
                uptime: '2 days, 14:32:18',
                free_heap: '234,567 bytes',
                api_url: 'http://192.168.1.100/api'
            };
            
            setTimeout(() => {
                document.getElementById('device-status').textContent = sampleStatus.status || 'Online';
                document.getElementById('device-ip').textContent = `IP: ${sampleStatus.ip}` || 'IP: --';
                document.getElementById('device-ssid').textContent = `SSID: ${sampleStatus.ssid}` || 'SSID: --';
                document.getElementById('device-time').textContent = `Time: ${sampleStatus.time}` || 'Time: --';
                document.getElementById('device-date').textContent = `Date: ${sampleStatus.date}` || 'Date: --';
                document.getElementById('device-uptime').textContent = `Uptime: ${sampleStatus.uptime}` || 'Uptime: --';
                document.getElementById('device-freeheap').textContent = `Free Heap: ${sampleStatus.free_heap}` || 'Free Heap: --';
                document.getElementById('device-apiurl').textContent = `API URL: ${sampleStatus.api_url}` || 'API URL: --';
                
                const statusElement = document.getElementById('device-status');

                if (sampleStatus.status && sampleStatus.status.toLowerCase().includes('online')) {
                    statusElement.className = 'font-bold text-green-600';
                } else if (sampleStatus.status && sampleStatus.status.toLowerCase().includes('error')) {
                    statusElement.className = 'font-bold text-red-600';
                } else {
                    statusElement.className = 'font-bold text-orange-500';
                }
                
                showNotification('Device status updated!', 'success');
                removeSpinner(button);
            }, 1000);
        };
    }
    
    const captureBtn = document.getElementById('capture-btn');
    if (captureBtn) {
        captureBtn.onclick = function() {
            const img = document.getElementById('capture-image');
            img.src = `${API_URL_ESP32_CAM}/capture-image?ts=${Date.now()}`;
        };
    }

    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('capture-image').src = 'image.png';
        document.getElementById('camera-stream').src = 'image.png';
    });
    </script>
</body>
</html>